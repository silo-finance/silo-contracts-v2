# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: RPC related tests (with cache)

env:
    RPC_MAINNET: ${{ secrets.RPC_MAINNET }}
    RPC_ARBITRUM: ${{ secrets.RPC_ARBITRUM }}
    RPC_OPTIMISM: ${{ secrets.RPC_OPTIMISM }}
    RPC_ANVIL: ${{ secrets.RPC_ANVIL }}
    RPC_SONIC: ${{ secrets.RPC_SONIC }}
    RPC_AVALANCHE: ${{ secrets.RPC_AVALANCHE }}
    PRIVATE_KEY: ${{ secrets.ANVIL_PRIVATE_KEY }}

on:
    push:

    pull_request:
        types: [ready_for_review]

jobs:
    silo-rpc-tests:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v3

            # Cache all git submodules (large gitmodules/* tree and .git/modules) to speed up CI.
            # Keyed only by .gitmodules so cache can be reused across commits; git will fetch deltas if submodule refs change.
            -   name: Cache git submodules
                uses: actions/cache@v4
                with:
                    path: |
                        gitmodules
                        .git/modules
                    key: gitmodules-v1-${{ hashFiles('.gitmodules') }}
                    restore-keys: |
                        gitmodules-v1-

            -   name: Init git submodules (uses cached clones when available)
                run: |
                    git submodule sync --recursive
                    git submodule update --init --recursive

            # Cache Foundry build artifacts (compiler cache + compiled contracts) so forge test doesn't recompile everything every run.
            # Foundry by default uses the local `cache` directory (see foundry.toml cache_path / out settings).
            -   name: Cache Foundry build artifacts
                uses: actions/cache@v4
                with:
                    path: cache
                    key: foundry-build-v1-${{ runner.os }}
                    restore-keys: |
                        foundry-build-v1-

            -   name: Show Foundry build cache (before tests)
                run: |
                    echo "=== Foundry build cache BEFORE tests ==="
                    if [ -d cache ]; then
                        du -sh cache || true
                        echo "--- solidity-files-cache.json (compiler dependency cache) ---"
                        find cache -maxdepth 2 -type f -name 'solidity-files-cache.json' | head -n 5 || true
                        echo "--- compiled artifacts under cache/foundry/out (first 40 files) ---"
                        if [ -d cache/foundry/out ]; then
                            find cache/foundry/out -maxdepth 4 -type f | head -n 40
                        else
                            echo "cache/foundry/out does not exist yet"
                        fi
                    else
                        echo "cache/ directory does not exist yet (first run or cache miss)"
                    fi

            -   name: Install Foundry
                uses: foundry-rs/foundry-toolchain@v1
                with:
                    version: v1.2.3

            -   name: Build silo foundry utils
                working-directory: ./gitmodules/silo-foundry-utils
                run: |
                    cargo build --release
                    cp target/release/silo-foundry-utils ../../silo-foundry-utils
                    ../../silo-foundry-utils --version

            # Foundry RPC cache path is NOT configurable (foundry.toml cache_path = build artifacts only).
            # Forge always writes to $HOME/.foundry/cache/rpc. On ubuntu-latest HOME=/home/runner, so we cache that path explicitly.
            -   name: Cache Foundry RPC (all chains and blocks)
                uses: actions/cache@v4
                with:
                    path: ~/.foundry/cache/rpc
                    key: foundry-rpc-${{ runner.os }}-v1
                    restore-keys: |
                        foundry-rpc-${{ runner.os }}-

            -   name: Show Foundry RPC cache
                run: |
                    forge cache ls 2>&1 || echo "No cache yet (first fork test will create it)"

            -   name: Run vaults tests (SiloVaultDeployerTest)
                run: FOUNDRY_PROFILE=vaults_tests forge test --mc "SiloVaultDeployerTest" -vv --ffi

            -   name: Show Foundry build cache (after first test)
                run: |
                    echo "=== Foundry build cache AFTER first test (SiloVaultDeployerTest) ==="
                    if [ -d cache ]; then
                        du -sh cache || true
                        echo "--- solidity-files-cache.json (compiler dependency cache) ---"
                        find cache -maxdepth 2 -type f -name 'solidity-files-cache.json' | head -n 5 || true
                        echo "--- compiled artifacts under cache/foundry/out (first 40 files) ---"
                        if [ -d cache/foundry/out ]; then
                            find cache/foundry/out -maxdepth 4 -type f | head -n 40
                        else
                            echo "cache/foundry/out does not exist (unexpected if tests compiled contracts)"
                        fi
                    else
                        echo "cache/ directory missing after test (unexpected)"
                    fi

            -   name: Run oracle tests (WrappedMetaVaultOracleAdapterTest)
                run: FOUNDRY_PROFILE=oracles forge test --mc "WrappedMetaVaultOracleAdapterTest" -vv --ffi

            -   name: Run oracle tests (PendleWrapperLPTOracle)
                run: FOUNDRY_PROFILE=oracles forge test --mc "PendleWrapperLPTOracle" -vv --ffi
            
            -   name: Run oracle tests (PendlePTOracleTest)
                run: FOUNDRY_PROFILE=oracles forge test --mc "PendlePTOracleTest" -vv --ffi

            -   name: Run oracle tests (PendleLPTOracleTest)
                run: FOUNDRY_PROFILE=oracles forge test --mc "PendleLPTOracleTest" -vv --ffi

            # -   name: Run oracle tests (ERC4626PriceManipulation)
            #     run: FOUNDRY_PROFILE=oracles forge test --mc "ERC4626PriceManipulation" -vv --ffi

            # -   name: Run core tests (BackwardsCompatibleGaugeLikeTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "BackwardsCompatibleGaugeLikeTest" -vv --ffi

            # -   name: Run core tests (SiloIncentivesControllerGaugeLikeIntegrationTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "SiloIncentivesControllerGaugeLikeIntegrationTest" -vv --ffi

            # -   name: Run core tests (LeverageWstkscUSDTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "LeverageWstkscUSDTest" -vv --ffi

            # -   name: Run core tests (Tutorial)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "Tutorial" -vv --ffi

            # -   name: Run core tests (SiloDeployerIntegrationTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "SiloDeployerIntegrationTest" -vv --ffi

            # -   name: Run core tests (SiloLensCompatibilityTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "SiloLensCompatibilityTest" -vv --ffi

            # -   name: Run core tests (SiloRouterV2ActionsTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "SiloRouterV2ActionsTest" -vv --ffi

            # -   name: Run core tests (SiloRouterPendleLPTsTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "SiloRouterPendleLPTsTest" -vv --ffi

            # -   name: Run core tests (SiloVerifierScriptTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "SiloVerifierScriptTest" -vv --ffi

            # -   name: Run core tests (EggsSonicPriceProvider)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "EggsSonicPriceProvider" -vv --ffi

            # -   name: Run core tests (PendleRewardsClaimerTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "PendleRewardsClaimerTest" -vv --ffi

            # -   name: Run core tests (DexSwapEnsoSonicTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "DexSwapEnsoSonicTest" -vv --ffi

            # -   name: Run core tests (DexSwapOdosSonicTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "DexSwapOdosSonicTest" -vv --ffi

            # -   name: Run core tests (LiquidationHelperOdosTest)
            #     run: FOUNDRY_PROFILE=core_test forge test --mc "LiquidationHelperOdosTest" -vv --ffi