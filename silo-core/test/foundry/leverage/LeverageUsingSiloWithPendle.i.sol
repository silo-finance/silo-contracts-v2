// SPDX-License-Identifier: BUSL-1.1
pragma solidity ^0.8.28;

import {Test} from "forge-std/Test.sol";

import {IERC20} from "openzeppelin5/token/ERC20/IERC20.sol";
import {SafeERC20} from "openzeppelin5/token/ERC20/utils/SafeERC20.sol";

import {IERC20R} from "silo-core/contracts/interfaces/IERC20R.sol";
import {ISiloConfig} from "silo-core/contracts/interfaces/ISiloConfig.sol";
import {IZeroExSwapModule} from "silo-core/contracts/interfaces/IZeroExSwapModule.sol";
import {ISilo} from "silo-core/contracts/interfaces/ISilo.sol";
import {ILeverageUsingSilo} from "silo-core/contracts/interfaces/ILeverageUsingSilo.sol";
import {LeverageUsingSiloWithZeroEx} from "silo-core/contracts/leverage/LeverageUsingSiloWithZeroEx.sol";

import {SiloLittleHelper} from "../_common/SiloLittleHelper.sol";
import {SwapRouterMock} from "./mocks/SwapRouterMock.sol";

import {MintableToken} from "../_common/MintableToken.sol";
import {SiloFixture, SiloConfigOverride} from "../_common/fixtures/SiloFixture.sol";

/*
    FOUNDRY_PROFILE=core_test  forge test -vv --ffi --mc LeverageUsingSiloWithPendleIntegrationTest

TODO triple check approvals
*/
contract LeverageUsingSiloWithPendleIntegrationTest is SiloLittleHelper, Test {
    using SafeERC20 for IERC20;

    uint256 constant _PRECISION = 1e18;

    ISiloConfig cfg;
    LeverageUsingSiloWithZeroEx siloLeverage;
    address collateralShareToken;
    address debtShareToken;
    SwapRouterMock swap;

    function setUp() public {
        cfg = _setUpLocalFixture();

        _deposit(1e18, address(1));
        _depositForBorrow(1e18, address(2));

        (,collateralShareToken,) = cfg.getShareTokens(address(silo0));
        (,, debtShareToken) = cfg.getShareTokens(address(silo1));

        siloLeverage = new LeverageUsingSiloWithZeroEx(address(this));
        siloLeverage.setRevenueReceiver(makeAddr("RevenueReceiver"));
        siloLeverage.setLeverageFee(0.0001e18);

        swap = new SwapRouterMock();

        token0.setOnDemand(false);
        token1.setOnDemand(false);
    }

    /*
        SILO: Silo_PT-wstkscUSD-29MAY2025_USDC.e.json
        "token0": "PT-wstkscUSD-29MAY2025",
                "PT-wstkscUSD-29MAY2025": "0xBe27993204Ec64238F71A527B4c4D5F4949034C3",

        "token1": "USDC.e",
            "USDC.e": "0x29219dd400f2Bf60E5a23d13Be72B486D4038894",


        "markets": [
    {
      "name": "wstkscUSD",
      "address": "0x6e4e95fab7db1f0524b4b0a05f0b9c96380b7dfa",
      "expiry": "2025-05-29T00:00:00.000Z",
      "pt": "146-0xbe27993204ec64238f71a527b4c4d5f4949034c3",
      "yt": "146-0xdcad0f3992a72ea0ce5eb703293a353249c0a76f",
      "sy": "146-0x896f4d49916ac5cfc36d7a260a7039ba4ea317b6",
      "underlyingAsset": "146-0x9fb76f7ce5fceaa2c42887ff441d46095e494206",
      "details": {
        "liquidity": 2408866.417461215,
        "pendleApy": 0.007519519963311915,
        "impliedApy": 0.13503247362013138,
        "feeRate": 0.0017529999999998935,
        "movement10Percent": {
          "ptMovementUpUsd": 132787.9726852208,
          "ptMovementDownUsd": 122797.73158955538,
          "ytMovementUpUsd": 72.6195624235031,
          "ytMovementDownUsd": 60.66263048237001
        },
        "yieldRange": {
          "min": 0.060000000000000005,
          "max": 0.3
        },
        "aggregatedApy": 0.0723537383448508,
        "maxBoostedApy": 0.08363301828981867
      },
      "isNew": false,
      "isPrime": false,
      "timestamp": "2025-02-26T08:24:21.000Z"


      https://api-v2.pendle.finance/core/v1/sdk/146/markets/0x6e4e95fab7db1f0524b4b0a05f0b9c96380b7dfa/swap?receiver=0x6d228Fa4daD2163056A48Fc2186d716f5c65E89A&slippage=0.05&enableAggregator=true&tokenIn=0x29219dd400f2Bf60E5a23d13Be72B486D4038894&tokenOut=0xBe27993204Ec64238F71A527B4c4D5F4949034C3&amountIn=1000000

      curl -X 'GET' \
  'https://api-v2.pendle.finance/core/v1/sdk/146/markets/0x6e4e95fab7db1f0524b4b0a05f0b9c96380b7dfa/swap?receiver=0x6d228Fa4daD2163056A48Fc2186d716f5c65E89A&slippage=0.05&enableAggregator=true&tokenIn=0x29219dd400f2Bf60E5a23d13Be72B486D4038894&tokenOut=0xBe27993204Ec64238F71A527B4c4D5F4949034C3&amountIn=1000000' \
  -H 'accept: application/json'

  {
  "method": "swapExactTokenForPt",
  "contractCallParamsName": [
    "receiver",
    "market",
    "minPtOut",
    "guessPtOut",
    "input",
    "limit"
  ],
  "contractCallParams": [
    "0x6d228fa4dad2163056a48fc2186d716f5c65e89a",
    "0x6e4e95fab7db1f0524b4b0a05f0b9c96380b7dfa",
    "960374",
    {
      "guessMin": "505460",
      "guessMax": "1263650",
      "guessOffchain": "1010920",
      "maxIteration": "30",
      "eps": "99509319545322"
    },
    {
      "tokenIn": "0x29219dd400f2bf60e5a23d13be72b486d4038894",
      "netTokenIn": "1000000",
      "tokenMintSy": "0x9fb76f7ce5fceaa2c42887ff441d46095e494206",
      "pendleSwap": "0xd4e9b0d466789d7f6201442eeccba6a75a552db0",
      "swapData": {
        "swapType": "1",
        "extRouter": "0x6131b5fae19ea4f9d964eac0408e4408b66337b5",
        "extCalldata": "0xe21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000004a000000000000000000000000000000000000000000000000000000000000006e000000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000029219dd400f2bf60e5a23d13be72b486d40388940000000000000000000000009fb76f7ce5fceaa2c42887ff441d46095e494206000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff00000000000000000000000000000000000000000000000000000000000003800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000408cc7a56b0000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c81dcc33704eb019ba2ace6705210195babf138a0e0002000000000000000000ef00000000000000000000000029219dd400f2bf60e5a23d13be72b486d4038894000000000000000000000000039e2fb66102314ce7b64ce5ce3e5183bc94ad3800000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000004099e4f62d0000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000c9fc8ec06bdbf7d5430f4f7e7ab82c4cc91f1f22000000000000000000000000ba1333333333a1ba1108e8412f11850a5c319ba90000000000000000000000000000000000000000000000001eafc438ff35856f000000000000000000000000039e2fb66102314ce7b64ce5ce3e5183bc94ad380000000000000000000000009fb76f7ce5fceaa2c42887ff441d46095e4942060000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000001000000000000000000000000000f558300000000000000000000000029219dd400f2bf60e5a23d13be72b486d40388940000000000000000000000009fb76f7ce5fceaa2c42887ff441d46095e494206000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f94600000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000e913c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027a7b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a22312e30303433363839363238323333313135222c22416d6f756e744f7574555344223a22312e30313334323533343638333233353335222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2231303034393331222c2254696d657374616d70223a313734383335343831302c22526f7574654944223a2266653235653564662d336261652d343836622d613863362d3339346130623836336532393a39366636343061352d326233392d343336342d613336392d653836303930303136333037222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a225165467947506e4d4137795279782b72486534542f39737778386375744d5076556c44677572507764573243794b777064364a49687178684c5573434a555046456b4f39474265493670625035416e34416e4671346b5a64326943374835762b4771476a76664e2b62582f4d3863736a4553736a30343869794e3636413344424a33466e41336e79516b52594b456a372f75734e585371422f48636454345055754d77463735306b554347544c58663955465656576d743849695157693138386450646c78634f4c497a374b3459512b394a306d2b4f42676a6344394a6d65323471795571746979733753576a714a4669524732306d466c415a73786f387746587976412f63617463434f757850694b583841765255746e51736f3436737743737662656775424c687931476132374f6f6a4745346258494466566d63547778676178734c455a7568703571434f454f71576d6c66673d3d227d7d000000000000",
        "needScale": false
      }
    },
    {
      "limitRouter": "0x0000000000000000000000000000000000000000",
      "epsSkipMarket": "0",
      "normalFills": [],
      "flashFills": [],
      "optData": "0x"
    }
  ],
  "tx": {
    "data": "0xc81f847a0000000000000000000000006d228fa4dad2163056a48fc2186d716f5c65e89a0000000000000000000000006e4e95fab7db1f0524b4b0a05f0b9c96380b7dfa00000000000000000000000000000000000000000000000000000000000ea776000000000000000000000000000000000000000000000000000000000007b674000000000000000000000000000000000000000000000000000000000013482200000000000000000000000000000000000000000000000000000000000f6ce8000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000005a80d1a4b1ea00000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000c4000000000000000000000000029219dd400f2bf60e5a23d13be72b486d403889400000000000000000000000000000000000000000000000000000000000f42400000000000000000000000009fb76f7ce5fceaa2c42887ff441d46095e494206000000000000000000000000d4e9b0d466789d7f6201442eeccba6a75a552db000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009a4e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000004a000000000000000000000000000000000000000000000000000000000000006e000000000000000000000000000000000000000000000000000000000000003e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000029219dd400f2bf60e5a23d13be72b486d40388940000000000000000000000009fb76f7ce5fceaa2c42887ff441d46095e494206000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff00000000000000000000000000000000000000000000000000000000000003800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000408cc7a56b0000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c81dcc33704eb019ba2ace6705210195babf138a0e0002000000000000000000ef00000000000000000000000029219dd400f2bf60e5a23d13be72b486d4038894000000000000000000000000039e2fb66102314ce7b64ce5ce3e5183bc94ad3800000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000004099e4f62d0000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000c9fc8ec06bdbf7d5430f4f7e7ab82c4cc91f1f22000000000000000000000000ba1333333333a1ba1108e8412f11850a5c319ba90000000000000000000000000000000000000000000000001eafc438ff35856f000000000000000000000000039e2fb66102314ce7b64ce5ce3e5183bc94ad380000000000000000000000009fb76f7ce5fceaa2c42887ff441d46095e4942060000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000001000000000000000000000000000f558300000000000000000000000029219dd400f2bf60e5a23d13be72b486d40388940000000000000000000000009fb76f7ce5fceaa2c42887ff441d46095e494206000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f94600000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000e913c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027a7b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a22312e30303433363839363238323333313135222c22416d6f756e744f7574555344223a22312e30313334323533343638333233353335222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2231303034393331222c2254696d657374616d70223a313734383335343831302c22526f7574654944223a2266653235653564662d336261652d343836622d613863362d3339346130623836336532393a39366636343061352d326233392d343336342d613336392d653836303930303136333037222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a225165467947506e4d4137795279782b72486534542f39737778386375744d5076556c44677572507764573243794b777064364a49687178684c5573434a555046456b4f39474265493670625035416e34416e4671346b5a64326943374835762b4771476a76664e2b62582f4d3863736a4553736a30343869794e3636413344424a33466e41336e79516b52594b456a372f75734e585371422f48636454345055754d77463735306b554347544c58663955465656576d743849695157693138386450646c78634f4c497a374b3459512b394a306d2b4f42676a6344394a6d65323471795571746979733753576a714a4669524732306d466c415a73786f387746587976412f63617463434f757850694b583841765255746e51736f3436737743737662656775424c687931476132374f6f6a4745346258494466566d63547778676178734c455a7568703571434f454f71576d6c66673d3d227d7d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    "to": "0x888888888889758F76e7103c6CbF23ABbF58F946",
    "from": "0x6d228fa4dad2163056a48fc2186d716f5c65e89a"
  },
  "tokenApprovals": [
    {
      "token": "0x29219dd400f2bf60e5a23d13be72b486d4038894",
      "amount": "1000000"
    }
  ],
  "data": {
    "amountOut": "1010920",
    "priceImpact": 0.00888193307916536
  }
}


SONIC BLOCK: 29961377

        */
}
